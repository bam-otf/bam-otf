# @bamotf/node

This library provides convenient access to the bamotf API from applications
written in server-side JavaScript.

## Requirements

Node 12 or higher.

## Installation

Install the package with:

```sh
npm install @bamotf/node --save
# or
yarn add @bamotf/node
# or
pnpm i @bamotf/node --save
```

## Usage

The package needs to be configured with your API Key, which is defined as a env
var during start up (see
[Running the server](../../README.md#1-running-the-server)).

Using it with CJS:

```js
const bamotf = require('@bamotf/node')('secret-key...')

bamotf.paymentIntents
  .retrieve({
    amount: 50,
    currency: 'USD',
    tolerance: 0.05,
    address: 'bc1q00hf9mlaxzej30cx5q6200c636ufdc4gjmqyuh',
  })
  .then(pi => console.log(pi.id))
  .catch(error => console.error(error))
```

Or using ES modules and `async`/`await`:

```js
import BamOtf from '@bamotf/node'

const bamotf = new BamOtf('my-fancy-token', {
  //   host: 'localhost',
  //   port: 21000,
})

const pi = await bamotf.paymentIntents.create({
  amount: 6.25,
  address: 'bc1q00hf9mlaxzej30cx5q6200c636ufdc4gjmqyuh',
})

console.log(pi.id)
```

### Usage with Deno

TODO: add instructions for Deno

`@bamotf/node` provides a `deno` export target. In your Deno project, import
`@bamotf/node` using an npm specifier:

Import using npm specifiers:

```js
import BamOtf from 'npm:@bamotf/node'
```

Please see [examples/bamotf-node-deno-sample][] for more detailed example and
instructions on how to use bamotf/node in Deno.

## Configuration

### Initialize with config object

The package can be initialized with several options:

```js
const bamotf = BamOtf('sk_test_...', {
  host: 'api.example.com',
  port: 123,
})
```

| Option | Default       | Description                     |
| ------ | ------------- | ------------------------------- |
| `host` | `'localhost'` | Host that requests are made to. |
| `port` | 21000         | Port that requests are made to. |

> **Note** Both `maxNetworkRetries` and `timeout` can be overridden on a
> per-request basis.

### Webhook signing

_bamotf_ can optionally sign the webhook events it sends to your endpoint,
allowing you to validate that they were not sent by a third-party.

Please note that you must pass the _raw_ request body, exactly as received from
_bamotf_, to the `constructEvent()` function; this will not work with a parsed
(i.e., JSON) request body.

You can find an example of how to use this with various JavaScript frameworks in
[`examples/webhook-signing`][examples/webhook-signing] folder, but here's what
it looks like:

```js
const {success, parsed} = bamotf.webhooks.constructEvent(
  webhookRawBody,
  webhookSignatureHeader,
  webhookSecret,
)
```

#### Testing Webhook signing

You can use `bamotf.webhooks.generateTestHeaderString` to mock webhook events
that come from _bamotf_:

```js
const payload = {
  id: 'evt_test_webhook',
  object: 'event',
}

const payloadString = JSON.stringify(payload, null, 2)
const secret = 'test_secret'

const header = bamotf.webhooks.generateTestHeaderString({
  payload: payloadString,
  secret,
})

const event = bamotf.webhooks.constructEvent(payloadString, header, secret)

if (!event.success) {
  throw new Error('Not Authorized')
}

// Do something with mocked signed event
expect(event.parsed.id).to.equal(payload.id)
```

## Features

### Client

#### Constructor

```typescript
constructor(apiKey: string, config?: BamOtfConfig)
```

- `apiKey`: The API key used for authentication.
- `config` (optional): Configuration options for the client. Supports the
  following properties:
  - `baseURL`: The base URL of the server. Defaults to
    `'http://localhost:3000'`.
  - `timeout`: The request timeout in milliseconds. Defaults to `60000`.

#### Example Usage

```typescript
import { BamOtf } from './client'

const apiKey = 'YOUR_API_KEY'
const bamOtf = new BamOtf(apiKey)

// Access the PaymentIntents module
const paymentIntents = bamOtf.paymentIntents

// Use the PaymentIntents module methods
paymentIntents.create(/* params */)
paymentIntents.retrieve(/* id */)
paymentIntents.list()
paymentIntents.update(/* id */, /* params */)
paymentIntents.cancel(/* id */, /* params */)
```

---

### Parse

The `parse` function is used to parse the response data received from the
server.

#### Example Usage

```typescript
import { parse } from './parse'

const responseData = /* raw response data from server */

// Parse the response data
const parsedData = parse(responseData)

// Use the parsed data
console.log(parsedData)
```

---

### PaymentIntents

The `PaymentIntents` class provides methods for interacting with payment intents
on the Bam-otf server.

#### Constructor

```typescript
constructor(client: AxiosInstance)
```

- `client`: An Axios instance used for making HTTP requests.

#### Methods

- `create(params: CreateBodyParams): Promise<CreateResult>`: Creates a new
  payment intent.
- `retrieve(id: string): Promise<RetrieveResult>`: Retrieves a payment intent by
  ID.
- `list(): Promise<ListResult>`: Retrieves a list of payment intents.
- `update(id: string, params: UpdateBodyParams): Promise<UpdateResult>`: Updates
  a payment intent.
- `cancel(id: string, params: CancelBodyParams = {}): Promise<CancelResult>`:
  Cancels a payment intent.

#### Example Usage

```typescript
import { PaymentIntents } from './payment-intents'

const paymentIntents = new PaymentIntents(/* axiosInstance */)

// Use the PaymentIntents module methods
paymentIntents.create(/* params */)
paymentIntents.retrieve(/* id */)
paymentIntents.list()
paymentIntents.update(/* id */, /* params */)
paymentIntents.cancel(/* id */, /* params */)
```

---

### Types

The `types` module provides various type definitions used in the Bam-otf server
implementation.

#### Example Usage

```typescript
import {CreateBodyParams, PaymentIntentStatus} from './types'

const status: PaymentIntentStatus = 'pending'

const params: CreateBodyParams = {
  address: '123 Main St',
  amount: 100,
  tolerance: 5,
}
```

---

### Webhooks

The `webhooks` module provides functions for handling webhooks in the Bam-otf
server.

#### Functions

- `constructEvent(webhookRawBody: string, webhookSignatureHeader: string, webhookSecret: string): EventConstructionResult`:
  Builds a webhook event from a raw body and signature header.
- `generateTestHeaderString(payload: string, secret: string): string`: Generates
  a test header string for mocking a webhook event.

#### Example Usage

```typescript
import { constructEvent, generateTestHeaderString } from './webhooks'

const rawBody = /* raw webhook body */
const signatureHeader = /* webhook signature header */
const secret = /* webhook secret */

// Construct the webhook event
const event = constructEvent(rawBody, signatureHeader, secret)

// Generate a test header string
const testHeader = generateTestHeaderString('payload', secret)
```

---
